$.validator.setDefaults({
	highlight : function(e) {
		$(e).closest(".form-group").removeClass("has-success").addClass(
				"has-error")
	},
	success : function(e) {
		e.closest(".form-group").removeClass("has-error").addClass(
				"has-success")
	},
	errorElement : "span",
	errorPlacement : function(e, r) {
		e.appendTo(r.is(":radio") || r.is(":checkbox") ? r.parent().parent()
				.parent() : r.parent())
	},
	errorClass : "help-block m-b-none",
	validClass : "help-block m-b-none"
}), $().ready(function() {
	
	onselect();
	//获取参数
	var sd=GetArgsFromHref();
	console.log(sd);
	if (typeof(sd)!= "undefined"){ 
		$("#staffId").val(sd);
		//等select 加载完了，在加载其他
		 setTimeout(function () { 
			 onselectPower(sd);
		    }, 500);
		 //修改title
		 $("#titleid").html("修改商城后台用户");
	}
	var e = "<i class='fa fa-times-circle'></i> ";
	$("#signupForm").validate({
		rules : {
			loginName : "required",
			password : {
					required : !0,
					minlength : 6
			},
			password2 : {
				required : !0,
				minlength : 6,
				equalTo: "#password"
			},
			nickname : "required",
			roleId : {
				required : !0
			}
		},
		messages : {
			loginName : e+"请输入用户名",
			password: {
					required : e+"请输入登陆密码",
					minlength : e+"登陆密码不能少于6位"
			},
			password2 : {
				required : e+"请输入确认密码",
				minlength :  e+"确认密码不能少于6位",
				equalTo: e+"两次密码输入不一致"
			},
			nickname :  e+"请输入真实姓名",
			roleId : {
				required : e+"请选择用户角色"
			}
			
		},submitHandler:function(form){  
			var roleId=$("#roleId").val();
			if(roleId=="0"){
				alert("请选择用户角色");
			}else{
				tjajx();
			}
			
        }   
	});
});
//保存
function tjajx(){
	$.ajax({
		type : "post",
		url : "/userinfo/createuser.do",
		data : $('#signupForm').serialize(),
		dataType : "json",
		success : function(data) {
			if(data.status=="200"){
				swal({title:"操作提示",text:"操作成功",type:"success",closeOnConfirm: false} ,
					function(){
					location.reload() 
					  });
			}else{
				swal({title:"操作提示",text:"操作失败", type:"error",closeOnConfirm: false })
			}
		}
	});
}
//加载 select
function onselect(){
	
	$.ajax({
		type : "post",
		url : "/userinfo/rolejsonAjax/list.do",
		data : "",
		dataType : "json",
		success : function(data) {
			if(data!=""){
				    var selObj = $("#roleId");  
				    $.each(data,function(i,n){
				    	var value=n.roleId;  
					    var text=n.roleName;  
					    selObj.append("<option value='"+value+"'>"+text+"</option>");  
				    });
			}else{
				swal({title:"操作提示",text:"获取根节点失败,请联系管理员", type:"error" })
			}
		}
	});
}

//ajax  查询 角色信息并显示在html页面
function onselectPower(id){
	console.log(id);
	$.ajax({
		type : "GET",
		url : "/userinfo/edit.do",
		data : "id="+id,
		dataType : "json",
		success : function(data) {
			console.log(data);
			if(data!=""){
				    $("#roleName").val(data.roleName);
				    $("#isdel").val(data.isdel);
				    $("#loginName").val(data.loginName);
				    $("#password").val(data.password);
				    $("#nickname").val(data.nickname);
				    $("#roleId option").each(function (){  
			            var txt = $(this).val();
			            if(txt==data.roleId){
			            	 $(this).attr("selected","selected");
			            }
				    });
			}else{
				swal({title:"操作提示",text:"获取用户信息出错,请联系管理员", type:"error" })
			}
		}
	});
}